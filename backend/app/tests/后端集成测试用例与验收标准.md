# 后端集成测试用例与验收标准

## 📋 概述

本文档为实习生提供完整的后端集成测试指南，基于产品需求文档(PRD)和API规范，帮助系统性地验证后端功能完整性，识别不可用接口，确保系统质量。

**测试目标**：
- 验证核心AI语音交互流程的完整性
- 确认所有API接口的可用性和正确性
- 验证权限控制机制的有效性
- 识别性能瓶颈和稳定性问题

## 🚀 测试环境准备

### 1. 环境配置检查

```bash
# 1. 检查后端服务状态
curl http://localhost:3000/health
# 期望响应: {"status":"ok","timestamp":1753900335.8781202}

# 2. 检查数据库连接
cd /home/devbox/project/backend
python -c "from app.config import get_database_url; print('DB URL:', get_database_url())"

# 3. 检查MCP服务器状态
ps aux | grep mcp
# 应该看到相关MCP进程运行

# 4. 检查环境变量
cat backend/.env | grep -E "(PORT|DB_|OPENAI_|TEST_)"
```

### 2. 测试数据准备

```bash
# 确认测试账号可用
echo "测试账号信息:"
echo "普通用户: $(grep TEST_USER_USERNAME backend/.env | cut -d'=' -f2) / $(grep TEST_USER_PASSWORD backend/.env | cut -d'=' -f2)"
echo "开发者: $(grep TEST_DEVELOPER_USERNAME backend/.env | cut -d'=' -f2) / $(grep TEST_DEVELOPER_PASSWORD backend/.env | cut -d'=' -f2)"
echo "管理员: $(grep TEST_ADMIN_USERNAME backend/.env | cut -d'=' -f2) / $(grep TEST_ADMIN_PASSWORD backend/.env | cut -d'=' -f2)"
```

## 🔐 认证与权限测试

### 测试用例 1: 用户认证流程

**测试目标**: 验证JWT认证机制的正确性

```bash
# 1.1 测试普通用户登录
curl -X POST "http://localhost:3000/api/v1/auth/token" \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "username=testuser_5090&password=8lpcUY2BOt"

# 验收标准:
# ✅ 返回状态码 200
# ✅ 响应包含 access_token 字段
# ✅ token_type 为 "bearer"
# ❌ 如果返回 401，说明认证失败
```

```bash
# 1.2 测试开发者登录
curl -X POST "http://localhost:3000/api/v1/auth/token" \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "username=devuser_5090&password=mryuWTGdMk"

# 1.3 测试管理员登录
curl -X POST "http://localhost:3000/api/v1/auth/token" \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "username=adminuser_5090&password=SAKMRtxCjT"
```

**常见问题排查**:
- 如果登录失败，检查 `.env` 文件中的测试账号配置
- 确认使用 `application/x-www-form-urlencoded` 而非 JSON 格式

### 测试用例 2: 权限控制验证

```bash
# 2.1 获取普通用户token
USER_TOKEN=$(curl -s -X POST "http://localhost:3000/api/v1/auth/token" \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "username=testuser_5090&password=8lpcUY2BOt" | \
  python3 -c "import sys, json; print(json.load(sys.stdin)['access_token'])")

# 2.2 测试普通用户访问基础接口（应该成功）
curl -X GET "http://localhost:3000/api/v1/tools" \
  -H "Authorization: Bearer $USER_TOKEN"

# 验收标准:
# ✅ 返回状态码 200
# ✅ 响应包含 tools 数组

# 2.3 测试普通用户访问开发者接口（应该失败）
curl -X GET "http://localhost:3000/api/v1/dev/tools" \
  -H "Authorization: Bearer $USER_TOKEN"

# 验收标准:
# ✅ 返回状态码 403 (Forbidden)
# ✅ 错误信息提示权限不足
```

## 🤖 核心AI交互流程测试

### 测试用例 3: 意图解析接口

**测试目标**: 验证AI理解用户意图的准确性

```bash
# 3.1 测试简单查询意图
curl -X POST "http://localhost:3000/api/v1/intent/interpret" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $USER_TOKEN" \
  -d '{
    "query": "今天深圳的天气怎么样",
    "session_id": "test-session-001",
    "user_id": 13
  }'

# 验收标准:
# ✅ 返回状态码 200
# ✅ 响应包含 type 字段 ("tool_call" 或 "direct_response")
# ✅ 如果是 tool_call，包含 tool_calls 数组
# ✅ 包含 content 字段作为AI回复
# ✅ session_id 正确返回
```

```bash
# 3.2 测试翻译意图
curl -X POST "http://localhost:3000/api/v1/intent/interpret" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $USER_TOKEN" \
  -d '{
    "query": "把hello world翻译成中文",
    "session_id": "test-session-002",
    "user_id": 13
  }'

# 3.3 测试无法识别的意图
curl -X POST "http://localhost:3000/api/v1/intent/interpret" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $USER_TOKEN" \
  -d '{
    "query": "asdfghjkl随机文本",
    "session_id": "test-session-003",
    "user_id": 13
  }'

# 验收标准:
# ✅ 系统应该优雅处理无法识别的输入
# ✅ 返回合理的错误提示或澄清请求
```

### 测试用例 4: 确认执行流程

```bash
# 4.1 先进行意图解析获取session_id
SESSION_RESPONSE=$(curl -s -X POST "http://localhost:3000/api/v1/intent/interpret" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $USER_TOKEN" \
  -d '{
    "query": "翻译hello为中文",
    "session_id": "test-session-004",
    "user_id": 13
  }')

echo "意图解析结果: $SESSION_RESPONSE"

# 4.2 确认执行
curl -X POST "http://localhost:3000/api/v1/intent/confirm" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $USER_TOKEN" \
  -d '{
    "session_id": "test-session-004",
    "user_input": "是的，确认执行"
  }'

# 验收标准:
# ✅ 返回状态码 200
# ✅ success 字段为 true
# ✅ content 字段包含执行结果
# ✅ error 字段为 null（成功时）
```

### 测试用例 5: 直接工具执行

```bash
# 5.1 测试翻译工具
curl -X POST "http://localhost:3000/api/v1/execute" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $USER_TOKEN" \
  -d '{
    "session_id": "test-session-005",
    "user_id": 13,
    "tool_id": "translate_text",
    "params": {
      "text": "Hello World",
      "target_language": "zh"
    }
  }'

# 验收标准:
# ✅ 返回状态码 200
# ✅ result 字段包含翻译结果
# ✅ tts 字段包含适合语音播报的文本
# ✅ session_id 正确返回
```

## 🛠️ 开发者功能测试

### 测试用例 6: 开发者工具管理

```bash
# 6.1 获取开发者token
DEV_TOKEN=$(curl -s -X POST "http://localhost:3000/api/v1/auth/token" \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "username=devuser_5090&password=mryuWTGdMk" | \
  python3 -c "import sys, json; print(json.load(sys.stdin)['access_token'])")

# 6.2 获取开发者工具列表
curl -X GET "http://localhost:3000/api/v1/dev/tools" \
  -H "Authorization: Bearer $DEV_TOKEN"

# 6.3 创建新工具
curl -X POST "http://localhost:3000/api/v1/dev/tools" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $DEV_TOKEN" \
  -d '{
    "tool_id": "test_tool_001",
    "name": "测试工具",
    "description": "用于集成测试的工具",
    "type": "http",
    "endpoint": {
      "url": "https://httpbin.org/post",
      "method": "POST"
    },
    "request_schema": {
      "type": "object",
      "properties": {
        "message": {"type": "string"}
      }
    },
    "response_schema": {
      "type": "object"
    }
  }'

# 验收标准:
# ✅ 创建成功返回 201
# ✅ 响应包含创建的工具信息
```

### 测试用例 7: MCP服务器状态监控

```bash
# 7.1 检查MCP服务器状态
curl -X GET "http://localhost:3000/api/v1/mcp/status" \
  -H "Authorization: Bearer $DEV_TOKEN"

# 验收标准:
# ✅ 返回状态码 200
# ✅ 响应包含各MCP服务器的状态信息
# ✅ 状态信息包括运行状态、进程ID等
```

## 📊 性能与稳定性测试

### 测试用例 8: 并发请求测试

```bash
# 8.1 并发意图解析测试
for i in {1..10}; do
  curl -X POST "http://localhost:3000/api/v1/intent/interpret" \
    -H "Content-Type: application/json" \
    -H "Authorization: Bearer $USER_TOKEN" \
    -d "{
      \"query\": \"测试并发请求 $i\",
      \"session_id\": \"concurrent-test-$i\",
      \"user_id\": 13
    }" &
done
wait

# 验收标准:
# ✅ 所有请求都应该成功返回
# ✅ 响应时间应该在合理范围内（<2秒）
# ✅ 不应该出现500错误或连接超时
```

### 测试用例 9: 响应时间测试

```bash
# 9.1 测试意图解析响应时间
time curl -X POST "http://localhost:3000/api/v1/intent/interpret" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $USER_TOKEN" \
  -d '{
    "query": "今天天气如何",
    "session_id": "perf-test-001",
    "user_id": 13
  }'

# 验收标准:
# ✅ 意图解析时间 ≤ 200ms (PRD要求)
# ✅ 工具执行时间 ≤ 300ms (PRD要求)
# ✅ 端到端总时间 ≤ 500ms (PRD要求)
```

## 🚨 错误处理测试

### 测试用例 10: 异常情况处理

```bash
# 10.1 测试无效token
curl -X GET "http://localhost:3000/api/v1/tools" \
  -H "Authorization: Bearer invalid_token_123"

# 验收标准:
# ✅ 返回状态码 401
# ✅ 错误信息清晰明确

# 10.2 测试缺失必要参数
curl -X POST "http://localhost:3000/api/v1/intent/interpret" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $USER_TOKEN" \
  -d '{
    "session_id": "error-test-001"
  }'

# 验收标准:
# ✅ 返回状态码 422 (Validation Error)
# ✅ 错误信息指出缺失的字段

# 10.3 测试不存在的工具
curl -X POST "http://localhost:3000/api/v1/execute" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $USER_TOKEN" \
  -d '{
    "session_id": "error-test-002",
    "user_id": 13,
    "tool_id": "non_existent_tool",
    "params": {}
  }'

# 验收标准:
# ✅ 返回适当的错误状态码
# ✅ 错误信息说明工具不存在
```

## 📋 完整测试检查清单

### 基础功能检查

- [ ] **服务启动**: 后端服务正常启动，健康检查通过
- [ ] **数据库连接**: 数据库连接正常，表结构完整
- [ ] **MCP服务器**: 所有MCP服务器正常运行
- [ ] **环境配置**: 所有必要的环境变量已配置

### 认证与权限检查

- [ ] **用户登录**: 三种角色用户都能正常登录
- [ ] **Token生成**: JWT token正确生成和验证
- [ ] **权限控制**: 不同角色的权限限制正确执行
- [ ] **Token过期**: Token过期后正确返回401错误

### 核心功能检查

- [ ] **意图解析**: AI能正确理解用户意图
- [ ] **工具调用**: 工具执行功能正常
- [ ] **确认流程**: 用户确认机制工作正常
- [ ] **结果返回**: 执行结果正确格式化和返回
- [ ] **TTS文本**: 语音播报文本生成正确

### 开发者功能检查

- [ ] **工具管理**: 开发者能创建、更新、删除工具
- [ ] **应用管理**: 应用管理功能正常
- [ ] **状态监控**: MCP服务器状态监控正常
- [ ] **测试功能**: 工具测试功能可用

### 性能与稳定性检查

- [ ] **响应时间**: 符合PRD中的性能要求
- [ ] **并发处理**: 能处理多个并发请求
- [ ] **错误处理**: 异常情况得到正确处理
- [ ] **资源使用**: CPU和内存使用在合理范围内

## 🔍 问题识别与报告

### 常见问题类型

1. **接口不可用**
   - 返回404：接口路径错误或未实现
   - 返回500：服务器内部错误
   - 连接超时：服务未启动或网络问题

2. **功能异常**
   - 意图解析错误：AI模型问题或配置错误
   - 工具执行失败：MCP服务器问题或工具配置错误
   - 权限控制失效：认证逻辑问题

3. **性能问题**
   - 响应时间过长：数据库查询慢或AI处理慢
   - 内存泄漏：长时间运行后性能下降
   - 并发问题：多用户同时使用时出现错误

### 问题报告模板

```markdown
## 问题报告

**问题类型**: [接口不可用/功能异常/性能问题]
**严重程度**: [高/中/低]
**发现时间**: [YYYY-MM-DD HH:MM:SS]

**问题描述**:
[详细描述问题现象]

**复现步骤**:
1. [步骤1]
2. [步骤2]
3. [步骤3]

**期望结果**:
[应该出现的正确结果]

**实际结果**:
[实际观察到的错误结果]

**错误信息**:
```
[粘贴完整的错误日志]
```

**环境信息**:
- 操作系统: [Linux/Mac/Windows]
- Python版本: [3.x.x]
- 后端服务版本: [commit hash]
- 测试时间: [YYYY-MM-DD HH:MM:SS]

**影响范围**:
[描述问题影响的功能模块]

**建议修复优先级**:
[基于业务影响的修复建议]
```

## 📈 验收标准总结

### 功能完整性标准

| 功能模块 | 验收标准 | 权重 |
|----------|----------|------|
| 用户认证 | 三种角色登录成功率 ≥ 95% | 20% |
| 意图解析 | 常见意图识别准确率 ≥ 80% | 25% |
| 工具执行 | 工具调用成功率 ≥ 90% | 25% |
| 权限控制 | 权限验证准确率 = 100% | 15% |
| 错误处理 | 异常情况处理覆盖率 ≥ 90% | 15% |

### 性能标准

| 性能指标 | 目标值 | 测量方法 |
|----------|--------|----------|
| 意图解析时间 | ≤ 200ms | 单次请求计时 |
| 工具执行时间 | ≤ 300ms | 单次请求计时 |
| 端到端响应时间 | ≤ 500ms | 完整流程计时 |
| 并发处理能力 | ≥ 10 QPS | 并发测试 |
| 系统可用性 | ≥ 99% | 连续运行测试 |

### 质量标准

- **代码覆盖率**: ≥ 80%
- **API文档完整性**: 100%
- **错误日志完整性**: 所有错误都有详细日志
- **安全性**: 无明显安全漏洞
- **可维护性**: 代码结构清晰，注释完整

## 🎯 测试执行建议

### 测试顺序

1. **环境准备** → 确保测试环境正常
2. **基础功能** → 验证核心API可用性
3. **认证权限** → 确保安全机制正常
4. **业务流程** → 测试完整的AI交互流程
5. **开发者功能** → 验证高级功能
6. **性能测试** → 确保性能符合要求
7. **异常测试** → 验证错误处理机制

### 测试频率

- **每日测试**: 基础功能和核心流程
- **每周测试**: 完整的集成测试
- **发布前测试**: 全面的验收测试
- **问题修复后**: 相关功能的回归测试

### 测试工具推荐

- **API测试**: curl, Postman, HTTPie
- **性能测试**: Apache Bench (ab), wrk
- **监控工具**: htop, iotop, netstat
- **日志分析**: tail, grep, awk

---

**注意事项**:
1. 测试前确保后端服务完全启动（等待30-60秒）
2. 使用正确的环境变量配置
3. 及时记录和报告发现的问题
4. 定期更新测试用例以覆盖新功能
5. 保持测试环境的清洁和一致性

---

## 🚨 已知问题记录

### 问题1: MCP服务器连接超时

**问题类型**: 功能异常
**严重程度**: 高
**发现时间**: 2025-08-17 18:30:00
**状态**: 待解决

**问题描述**:
在执行MCP工具（如maps_weather天气查询工具）时，出现连接超时错误：
```
连接到 MCP 服务器 amap-maps 超时 (10秒)
```

**复现步骤**:
1. 启动后端服务
2. 确保MCP服务器（amap-maps）正在运行
3. 调用 `/api/v1/execute` 接口执行 `maps_weather` 工具
4. 传入参数：`{"city": "北京"}`

**期望结果**:
工具执行成功，返回天气信息，状态码200

**实际结果**:
工具执行失败，返回400错误，提示连接超时

**错误信息**:
```json
{
  "detail": "连接到 MCP 服务器 amap-maps 超时 (10秒)"
}
```

**环境信息**:
- 操作系统: Linux 5.15.167.4-microsoft-standard-WSL2
- Python版本: 3.12.3
- 后端服务版本: Demo_Echo_Backend
- 测试时间: 2025-08-17 18:30:00

**影响范围**:
- MCP工具执行功能完全不可用
- 影响所有依赖MCP服务器的工具（地图、天气、AI等）
- 核心业务流程中断

**问题分析**:
1. **进程管理问题**: 多个amap-maps相关进程同时运行，导致进程混淆
2. **连接复用失败**: 系统尝试复用错误的进程PID
3. **超时配置**: 10秒超时可能过短，但用户反馈1秒内应该有响应
4. **asyncio上下文**: 存在事件循环上下文不一致的问题

**具体错误原因分析**:

**1. 后端服务启动时MCP进程混乱**
- 后端启动时自动启动了多个MCP服务器进程
- 包括：`@amap/amap-maps-mcp-server`、`mcp-amap`、`npm exec @amap/` 等
- 这些进程使用相同的端口或资源，导致冲突

**2. 进程识别和复用逻辑错误**
- 系统通过进程名称匹配来识别MCP进程
- 但存在多个名称相似的进程（如 `amap-maps` 和 `mcp-amap`）
- 系统错误地选择了错误的进程进行连接

**3. 连接目标错误**
- 系统尝试连接到PID 71700（错误的mcp-amap进程）
- 而不是正确的 `@amap/amap-maps-mcp-server` 进程
- 错误的进程无法处理MCP协议请求，导致连接超时

**4. 进程清理机制不完善**
- 虽然有进程清理逻辑，但清理时机和范围不够精确
- 清理后可能仍有残留进程或新进程启动
- 进程状态检查逻辑存在竞态条件

**5. 环境变量和配置冲突**
- 多个MCP服务器可能使用相同或冲突的环境变量
- 配置文件路径解析可能存在问题
- 进程启动参数不一致导致行为差异

**已尝试的解决方案**:
1. ✅ **进程清理**: 手动清理重复的MCP进程
2. ✅ **超时调整**: 增加连接超时时间到30秒
3. ✅ **同步包装器**: 使用subprocess避免asyncio问题
4. ✅ **路径修复**: 修复子进程的Python模块导入问题
5. ❌ **连接问题**: 仍然无法解决连接超时

**详细解决方案分析**:

**1. 进程清理方案** ✅
- **具体操作**: 手动使用 `ps aux | grep amap` 识别重复进程
- **清理命令**: `kill -9 PID` 强制终止错误进程
- **效果**: 临时解决了进程冲突，但重启后问题重现
- **局限性**: 手动操作，无法自动化，重启后失效

**2. 超时调整方案** ✅
- **具体操作**: 在 `mcp_servers.json` 中增加timeout配置到30秒
- **配置内容**: 设置default、ping、warmup、validation等超时参数
- **效果**: 减少了超时错误，但未解决根本的连接问题
- **局限性**: 只是延长了等待时间，未解决连接建立失败

**3. 同步包装器方案** ✅
- **具体操作**: 创建 `execute_tool_sync_wrapper` 使用subprocess执行
- **技术实现**: 在独立进程中运行MCP客户端，避免asyncio上下文问题
- **效果**: 解决了asyncio错误，但仍有模块导入问题
- **局限性**: 进程间通信复杂，路径解析仍有问题

**4. 路径修复方案** ✅
- **具体操作**: 修复子进程中的Python模块导入路径
- **技术实现**: 使用多种路径策略查找MCP客户端模块
- **效果**: 解决了模块导入错误，但连接问题依然存在
- **局限性**: 只解决了导入问题，未解决MCP服务器连接问题

**5. 连接问题方案** ❌
- **尝试内容**: 多种MCP客户端连接方式
- **失败原因**: 无法建立到正确MCP服务器的连接
- **根本问题**: MCP进程管理和识别逻辑存在缺陷

**建议修复优先级**: 最高优先级
**建议修复方向**:
1. 改进MCP进程管理，避免重复进程
2. 优化连接建立逻辑，减少超时概率
3. 考虑使用HTTP API替代MCP协议
4. 实现更智能的重试和故障转移机制

**相关文件**:
- `backend/app/utils/mcp_client.py` - MCP客户端包装器
- `backend/app/services/mcp_manager.py` - MCP服务器管理器
- `MCP_Client/mcp_client.py` - 核心MCP客户端库
- `MCP_Client/config/mcp_servers.json` - MCP服务器配置

**测试用例影响**:
- `test_5_1_translate_tool_execution` - 高德地图天气查询工具执行测试
- 所有依赖MCP工具的功能测试

**测试结果总结**:
根据最新测试运行结果，测试状态如下：

✅ **测试通过** (无问题):
- 测试1-3: 基础功能测试
- 测试6-7: 核心业务流程测试
- 测试10: 开发者功能测试

❌ **测试失败** (由不同问题导致):
- 测试4-5: 工具执行测试
  - `test_5_1_translate_tool_execution`: 高德地图天气查询工具执行失败
  - 失败原因: 连接到MCP服务器amap-maps超时(10秒)
  - 根本原因: MCP进程管理和连接建立问题

- 测试8: 并发性能测试
  - `test_8_1_concurrent_intent_interpretation`: 并发意图解析测试失败
  - 失败原因: 响应时间过长，实际41.86秒，超过2秒限制
  - 根本原因: 并发处理性能问题，可能受MCP连接问题影响

- 测试9: 响应时间性能测试
  - `test_9_1_intent_interpretation_response_time`: 响应时间要求测试失败
  - 失败原因: 响应时间严重超标，超出PRD要求数倍
  - 具体数据:
    - 意图解析时间: 4322.10ms (要求≤200ms，超出21.6倍)
    - 工具执行时间: 7256.02ms (要求≤300ms，超出24.2倍)
    - 端到端总时间: 4322.10ms (要求≤500ms，超出8.6倍)
  - 根本原因: 系统性能瓶颈，可能受模型连接问题影响

**影响评估**:
- 基础功能、认证权限、业务流程等核心功能正常
- MCP工具执行功能受影响
- 并发处理性能不达标，影响系统扩展性
- 响应时间严重超标，不满足PRD性能要求
- 系统整体稳定性良好，问题集中在特定模块和性能方面

---

**最后更新**: 2025-08-17 18:30:00
**问题状态**: 待解决
